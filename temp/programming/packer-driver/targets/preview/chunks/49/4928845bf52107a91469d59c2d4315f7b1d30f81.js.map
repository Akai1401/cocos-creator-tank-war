{"version":3,"sources":["file:///Users/akai/Data/cocos/TankWar/assets/script/playCtrl.ts"],"names":["_decorator","Collider2D","Component","Contact2DType","director","instantiate","Label","Node","Prefab","Vec3","Tank","ccclass","property","playCtrl","type","onBeginContactMyBullet","selfCollider","otherCollider","contact","node","name","setTimeout","destroy","tank","hp","window","socketManager","send","JSON","stringify","event","data","id","myTankId","HP","onLoad","labelNode","labelComponent","addComponent","string","slice","setPosition","addChild","hpNode","hpComponent","userListArr","filter","item","forEach","userNode","tankPrefab","userListContainer","onmessage","parse","getChildByName","x","y","setRotationFromEuler","angle","bullet","PlayerPos","getPosition","collider","getComponent","on","BEGIN_CONTACT","removeChild","newUserListArr","length","close","alert","loadScene"],"mappings":"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","sourcesContent":["import {\n  _decorator,\n  Collider2D,\n  Component,\n  Contact2DType,\n  director,\n  instantiate,\n  IPhysics2DContact,\n  Label,\n  Node,\n  Prefab,\n  UIOpacity,\n  Vec3,\n} from \"cc\";\nimport { Tank } from \"./tank\";\n\nconst { ccclass, property } = _decorator;\n\n@ccclass(\"playCtrl\")\nexport class playCtrl extends Component {\n  @property({\n    type: Tank,\n  })\n  public tank: Tank;\n\n  @property({ type: Prefab })\n  public tankPrefab: Prefab = null;\n\n  @property({ type: Prefab })\n  public bullet: Prefab = null;\n\n  @property({ type: Node })\n  public userListContainer: Node = null;\n\n  onBeginContactMyBullet(\n    selfCollider: Collider2D,\n    otherCollider: Collider2D,\n    contact: IPhysics2DContact | null\n  ) {\n    if (\n      otherCollider.node.name === \"wall\" ||\n      otherCollider.node.name === \"tank\"\n    ) {\n      // hide bullet\n      setTimeout(() => {\n        selfCollider.node.destroy();\n      }, 1);\n    }\n\n    if (otherCollider.node.name === \"tank\") {\n      // reduce HP\n      this.tank.hp -= 10;\n\n      (window as any).socketManager.send(\n        JSON.stringify({\n          event: \"reduceHP\",\n          data: { id: (window as any).myTankId, HP: this.tank.hp },\n        })\n      );\n    }\n  }\n\n  onLoad() {\n    // create name\n    const labelNode = new Node();\n    const labelComponent = labelNode.addComponent(Label);\n    labelComponent.string = (window as any).myTankId.slice(0, 3) + \" (You)\";\n    labelNode.setPosition(new Vec3(0, 70, 0));\n    this.tank.node.addChild(labelNode);\n\n    // create HP\n    const hpNode = new Node();\n    const hpComponent = hpNode.addComponent(Label);\n    hpComponent.string = \"HP: \" + this.tank.hp;\n    hpNode.name = \"HP\";\n    hpNode.setPosition(new Vec3(0, 110, 0));\n    this.tank.node.addChild(hpNode);\n\n    // render other tanks\n    (window as any).userListArr\n      .filter((item: any) => item?.id !== (window as any).myTankId)\n      .forEach((data: any) => {\n        const userNode = instantiate(this.tankPrefab);\n        const labelNode = new Node();\n        const labelComponent = labelNode.addComponent(Label);\n        labelComponent.string = data?.id?.slice(0, 3);\n        labelNode.setPosition(new Vec3(0, 70, 0));\n\n        const hpNode = new Node();\n        const hpComponent = hpNode.addComponent(Label);\n        hpComponent.string = \"HP: \" + this.tank.hp;\n        hpNode.name = \"HP\";\n        hpNode.setPosition(new Vec3(0, 110, 0));\n\n        userNode.addChild(labelNode);\n        userNode.addChild(hpNode);\n        userNode.name = data?.id;\n\n        this.userListContainer.addChild(userNode);\n      });\n\n    (window as any).socketManager.onmessage = (event: any) => {\n      // console.log(\"Message from server:\", event.data);\n      const data = JSON.parse(event.data);\n      if (data?.event === \"play\") {\n        const userNode = this.userListContainer.getChildByName(data.id);\n        if (userNode) {\n          userNode.setPosition(data.x, data.y);\n          userNode.setRotationFromEuler(new Vec3(0, 0, data.angle));\n        }\n      }\n      if (data?.event === \"fire\") {\n        const userNode = this.userListContainer.getChildByName(data.id);\n        if (userNode) {\n          let bullet = instantiate(this.bullet);\n          const PlayerPos = userNode.getPosition();\n          if (bullet) {\n            bullet.setPosition(PlayerPos);\n            bullet.setRotationFromEuler(new Vec3(0, 0, data.angle));\n            this.userListContainer.addChild(bullet);\n            bullet.name = \"enemy_bullet\";\n\n            let collider = bullet.getComponent(Collider2D);\n            if (collider) {\n              collider.on(\n                Contact2DType.BEGIN_CONTACT,\n                this.onBeginContactMyBullet,\n                this\n              );\n            }\n          }\n        }\n      }\n      if (data?.event === \"reduceHP\") {\n        const userNode = this.userListContainer.getChildByName(data.id);\n        if (userNode) {\n          const hpNode = userNode.getChildByName(\"HP\");\n          if (hpNode) {\n            hpNode.getComponent(Label).string = \"HP: \" + data.HP;\n          }\n        }\n        if (data.id === (window as any).myTankId) {\n          this.tank.hp = data.HP;\n          const hpNode = this.tank.node.getChildByName(\"HP\");\n          if (hpNode) {\n            hpNode.getComponent(Label).string = \"HP: \" + data.HP;\n          }\n        }\n        if (data.HP <= 0) {\n          this.userListContainer.removeChild(\n            this.userListContainer.getChildByName(data.id)\n          );\n          (window as any).userListArr = (window as any).userListArr.filter(\n            (item: any) => item.id !== data.id\n          );\n        }\n      }\n\n      if (data?.event === \"disconnect\") {\n        this.userListContainer.removeChild(\n          this.userListContainer.getChildByName(data.id)\n        );\n        const newUserListArr = (window as any).userListArr.filter(\n          (item: any) => item.id !== data.id\n        );\n        (window as any).userListArr = newUserListArr;\n\n        if ((window as any).userListArr.length === 1) {\n          (window as any).socketManager.close();\n          setTimeout(() => {\n            alert(\"You win!\");\n            director.loadScene(\"menu\");\n          }, 500);\n        }\n      }\n    };\n  }\n}\n"]}